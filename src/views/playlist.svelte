<script>
    import { _ } from "svelte-i18n";
    import { onDestroy, onMount } from "svelte";
    import { replace, location } from "svelte-spa-router";
    import { API, PageTitle } from "~/stores/state";
    import { getSongsFromPlaylist } from "~/logic/song";
    import Rating from "~/components/rating/rating.svelte";
    import Tabulator from "~/components/lister/Tabulator.svelte";
    import PlaylistRemoveFrom from "~/components/playlist/playlist_removeFrom2.svelte";
    import Actions from "~/components/action/actions.svelte";
    import MassRater from "~/components/lister/massRater.svelte";
    import Art from "~/components/art.svelte";
    import DrawerEdit from "~/components/action/drawers/drawerPlaylistEdit.svelte";
    import DrawerDelete from "~/components/action/drawers/drawerPlaylistDelete.svelte";
    import Portal from "~/components/portal.svelte";
    import Badge from "~/components/badge.svelte";
    import { errorHandler } from "~/logic/helper.js";
    import {
        moveHandle,
        moveHandleDisabled,
        songsPreset,
    } from "~/components/lister/columns.js";
    import MaterialSymbol from "~/components/materialSymbol.svelte";
    import { capitalize } from "lodash-es";

    export let params = {};

    let playlist;
    let songs = [];
    let loading = true;
    let playlistType = "playlist";
    let drawerEdit, drawerDelete;
    let tabulator = null;
    let columns = [];

    $: songs = songs;
    $: playlist = playlist;
    $: $PageTitle = playlist?.name || $_("text.playlist");
    $: tabulator, setupEvents();

    function afterDelete(e) {
        if (playlist?.id === e.detail.id) {
            replace("#/playlists");
        }
    }

    function setupEvents() {
        if (!tabulator || playlistType !== "playlist") return;

        // hide moveHandle if table has been sorted
        tabulator.on("dataSorting", () => {
            if (tabulator.getSorters().length > 0) {
                tabulator.hideColumn("moveHandle");
                tabulator.showColumn("moveHandleDisabled");
            } else {
                tabulator.hideColumn("moveHandleDisabled");
                tabulator.showColumn("moveHandle");
            }
        });

        tabulator.on("rowMoved", async () => {
            let allItems = tabulator.getData();
            let ids = allItems.map((obj) => obj.id);
            let newOrders = Array.from(allItems.keys(), (n) => n + 1);

            let result = await $API.playlistEdit({
                filter: playlist.id,
                items: ids.join(","),
                tracks: newOrders.join(","),
            });

            if (result.error) {
                errorHandler("editing playlist", result.error);
            }

            songs = allItems;
        });
    }

    onMount(async () => {
        if ($location.startsWith("/mix")) {
            // artist mix
            playlistType = "mix";
            playlist = await $API.artist({ filter: params.id });

            if (playlist.error) {
                errorHandler("getting artist for playlist mix", playlist.error);
                loading = false;
                return;
            }

            songs = await getSongsFromPlaylist({
                id: params.id,
                type: "artist_mix",
            });

            if (songs.error) {
                errorHandler("getting songs from playlist", songs.error);
                loading = false;
                return;
            }
        } else {
            playlist = await $API.playlist({ filter: params.id });

            if (playlist.error) {
                loading = false;
                return;
            }

            if (playlist?.id) {
                songs = await getSongsFromPlaylist({
                    id: params.id,
                    type: "playlist",
                });

                if (playlist.id.match(/^smart_/)) {
                    playlistType = "smartlist";
                }
            }
        }

        columns =
            playlistType === "playlist"
                ? [moveHandle, moveHandleDisabled, ...songsPreset]
                : songsPreset;

        loading = false;

        setupEvents();
    });

    onDestroy(() => {
        if (!tabulator || playlistType !== "playlist") return;

        tabulator?.off("dataSorting");
        tabulator?.off("rowMoved");
    });
</script>

{#if loading}
    <p>{$_("text.loading")}</p>
{:else if playlist.error}
    <p>{$_("text.noItemsFound")}</p>
{:else if playlist?.id}
    <div class="page-wrapper">
        <div class="details-container">
            <div class="details">
                <div class="cover-rating">
                    <div class="art-container">
                        <Art
                            size="large"
                            data={playlist}
                            type={playlistType}
                            radius="6px"
                        />
                    </div>

                    {#if playlistType !== "mix"}
                        <div class="rating">
                            <Rating type="playlist" data={playlist} />
                        </div>
                    {/if}
                </div>

                <div class="info">
                    <div class="name">
                        <div class="type">
                            {#if playlistType === "smartlist"}
                                <Badge text={$_("text.smartlist")} />
                            {:else if playlistType === "mix"}
                                <Badge text={$_("text.mix")} />
                            {:else}
                                <Badge text={$_("text.playlist")} />
                            {/if}
                        </div>

                        <h1 class="title">
                            {playlist.name}
                        </h1>
                    </div>

                    {#if playlistType !== "mix"}
                        <div class="meta-container">
                            <div class="meta-entry">
                                <span class="meta-field">
                                    {$_("text.items")}
                                </span>
                                <span class="meta-value">
                                    {playlist.items}
                                </span>
                            </div>

                            <div class="meta-entry">
                                <span class="meta-field">
                                    {$_("text.owner")}
                                </span>
                                <span class="meta-value">
                                    {playlist.owner}
                                </span>
                            </div>

                            <div class="meta-entry">
                                <span class="meta-field">
                                    {$_("text.type")}
                                </span>
                                <span class="meta-value">
                                    {capitalize(playlist.type)}
                                </span>
                            </div>
                        </div>
                    {/if}

                    {#if playlistType === "playlist"}
                        <div class="playlist-actions">
                            <sl-button
                                variant="primary"
                                on:click={() => drawerEdit.show()}
                                title={$_("text.edit")}
                            >
                                <MaterialSymbol name="edit" slot="prefix" />
                                {$_("text.edit")}
                            </sl-button>

                            <sl-button
                                variant="neutral"
                                on:click={() => drawerDelete.show()}
                                title={$_("text.delete")}
                            >
                                <MaterialSymbol name="delete" slot="prefix" />
                                {$_("text.delete")}
                            </sl-button>
                        </div>
                    {/if}
                </div>
            </div>
        </div>

        <div class="songs-container">
            <div class="songs">
                <div class="lister-tabulator">
                    <div class="lister-tabulator__actions">
                        <Actions
                            type="songs"
                            displayMode="fullButtons"
                            showShuffle={songs.length > 1}
                            data={{ songs: songs }}
                        />

                        <MassRater bind:tabulator type="song" />

                        {#if playlistType === "playlist"}
                            <PlaylistRemoveFrom
                                bind:tabulator
                                bind:songs
                                playlistID={playlist.id}
                            />
                        {/if}
                    </div>

                    <Tabulator
                        bind:tabulator
                        bind:data={songs}
                        {columns}
                        options={{
                            movableRows: true,
                            persistenceID: "playlist",
                        }}
                    ></Tabulator>
                </div>
            </div>
        </div>
    </div>

    <Portal>
        <DrawerEdit bind:this={drawerEdit} bind:playlist />
    </Portal>

    <Portal>
        <DrawerDelete
            bind:this={drawerDelete}
            bind:playlist
            on:playlistDeleted={afterDelete}
        />
    </Portal>
{/if}

<style>
    .page-wrapper {
        display: grid;
        gap: var(--spacing-xxl);
    }

    .details-container {
        container-name: playlist-details-wrapper;
        container-type: inline-size;
    }

    .cover-rating {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }

    .art-container {
        max-width: 240px;
        aspect-ratio: 1 / 1;
        overflow: hidden;
        font-size: 0;
        margin-block-end: var(--spacing-lg);
    }

    .info {
        display: flex;
        gap: var(--spacing-xl);
        flex-direction: column;
    }

    .title {
        --roboto-opsz: 50;
        line-height: 1.1;
        font-weight: 300;
        display: flex;
    }

    .playlist-actions {
        display: flex;
        flex-direction: row;
        gap: var(--spacing-sm);
    }

    .type {
        --roboto-opsz: 32;
        display: flex;
        font-size: 14px;
        font-weight: 300;
        text-transform: uppercase;
        align-items: center;
    }

    .songs-container {
        overflow-y: hidden; /* prevent Tabulator from growing horizontally */
    }

    @container playlist-details-wrapper (min-width: 500px) {
        .details {
            display: flex;
            gap: var(--spacing-xl);
            margin-block-end: 0;
            padding: unset;
        }

        .details {
            background-color: unset;
            box-shadow: unset;
        }

        .title {
            justify-content: left;
        }

        .art-container {
            max-width: 180px;
        }

        .type {
            justify-content: start;
        }
    }

    @container playlist-details-wrapper (min-width: 800px) {
        .title {
            font-size: 40px;
            font-weight: 200;
        }

        .art-container {
            max-width: 240px;
        }
    }
</style>
